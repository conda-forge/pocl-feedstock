From 6d7af28aa25b932d93b56fb4e5d7d1c77bcc6944 Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Mon, 17 Jul 2023 06:56:30 -0500
Subject: [PATCH 1/3] Add a runtime check for cuda driver version

---
 lib/CL/devices/cuda/pocl-cuda.c | 39 +++++++++++++++++++++++++--------
 1 file changed, 30 insertions(+), 9 deletions(-)

diff --git a/lib/CL/devices/cuda/pocl-cuda.c b/lib/CL/devices/cuda/pocl-cuda.c
index e41a84059..c5a0a5554 100644
--- a/lib/CL/devices/cuda/pocl-cuda.c
+++ b/lib/CL/devices/cuda/pocl-cuda.c
@@ -396,19 +396,40 @@ pocl_cuda_init (unsigned j, cl_device_id dev, const char *parameters)
       dev->max_clock_frequency /= 1000;
       GET_CU_PROP (TEXTURE_ALIGNMENT, dev->mem_base_addr_align);
       GET_CU_PROP (INTEGRATED, dev->host_unified_memory);
+    }
+  if (CUDA_CHECK_ERROR (result, "cuDeviceGetAttribute"))
+    ret = CL_INVALID_DEVICE;
+
+  if (ret != CL_INVALID_DEVICE)
+    {
+      int driver_version = 0;
+      result = cuDriverGetVersion(&driver_version);
+      if (CUDA_CHECK_ERROR (result, "cuDriverGetVersion"))
+	{
+          ret = CL_INVALID_DEVICE;
+	}
+      else
+	{
 #if CUDA_VERSION >= 11010
-      GET_CU_PROP (READ_ONLY_HOST_REGISTER_SUPPORTED, data->supports_cu_mem_host_register);
-#elif defined(__aarch64__) || defined(__arm__)
-      // For cuda < 11.1, we don't know if the device supports cuMemHostRegister
-      // or not. Let's assume that it doesn't in ARM devices.
-      // This gives a false negative for Jetson Xavier, but it is the best we could do.
-      data->supports_cu_mem_host_register = 0;
+          if (driver_version >= 11010)
+	    {
+              GET_CU_PROP (READ_ONLY_HOST_REGISTER_SUPPORTED, data->supports_cu_mem_host_register);
+              if (CUDA_CHECK_ERROR (result, "cuDeviceGetAttribute"))
+                ret = CL_INVALID_DEVICE;
+            } else {
 #else
-      data->supports_cu_mem_host_register = 1;
+            {
+#endif
+#if defined(__aarch64__) || defined(__arm__)
+              // For cuda < 11.1, we don't know if the device supports cuMemHostRegister
+              // or not. Let's assume that it doesn't in ARM devices.
+              // This gives a false negative for Jetson Xavier, but it is the best we could do.
+              data->supports_cu_mem_host_register = pocl_get_bool_option ("POCL_CUDA_SUPPORTS_CU_MEM_HOST_REGISTER", 0);
+#else
+              data->supports_cu_mem_host_register = pocl_get_bool_option ("POCL_CUDA_SUPPORTS_CU_MEM_HOST_REGISTER", 1);
 #endif
+            }
     }
-  if (CUDA_CHECK_ERROR (result, "cuDeviceGetAttribute"))
-    ret = CL_INVALID_DEVICE;
 
   dev->preferred_wg_size_multiple = 32;
   dev->preferred_vector_width_char = 1;

From a973f6eb022eb19754d39554196ff9d5d8d4ae4f Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Mon, 17 Jul 2023 07:05:45 -0500
Subject: [PATCH 2/3] fix parens

---
 lib/CL/devices/cuda/pocl-cuda.c | 1 +
 1 file changed, 1 insertion(+)

diff --git a/lib/CL/devices/cuda/pocl-cuda.c b/lib/CL/devices/cuda/pocl-cuda.c
index c5a0a5554..23eacd50d 100644
--- a/lib/CL/devices/cuda/pocl-cuda.c
+++ b/lib/CL/devices/cuda/pocl-cuda.c
@@ -429,6 +429,7 @@ pocl_cuda_init (unsigned j, cl_device_id dev, const char *parameters)
               data->supports_cu_mem_host_register = pocl_get_bool_option ("POCL_CUDA_SUPPORTS_CU_MEM_HOST_REGISTER", 1);
 #endif
             }
+	}
     }
 
   dev->preferred_wg_size_multiple = 32;

From 36432a578c98af22e13ac8b3804ff3f304c5b79a Mon Sep 17 00:00:00 2001
From: Isuru Fernando <isuruf@gmail.com>
Date: Mon, 17 Jul 2023 07:18:51 -0500
Subject: [PATCH 3/3] Fix reading attribute

---
 lib/CL/devices/cuda/pocl-cuda.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/lib/CL/devices/cuda/pocl-cuda.c b/lib/CL/devices/cuda/pocl-cuda.c
index 23eacd50d..1f76d4a8c 100644
--- a/lib/CL/devices/cuda/pocl-cuda.c
+++ b/lib/CL/devices/cuda/pocl-cuda.c
@@ -412,8 +412,11 @@ pocl_cuda_init (unsigned j, cl_device_id dev, const char *parameters)
 	{
 #if CUDA_VERSION >= 11010
           if (driver_version >= 11010)
-	    {
-              GET_CU_PROP (READ_ONLY_HOST_REGISTER_SUPPORTED, data->supports_cu_mem_host_register);
+            {
+              int value;
+              result = cuDeviceGetAttribute (&value,
+                CU_DEVICE_ATTRIBUTE_READ_ONLY_HOST_REGISTER_SUPPORTED, data->device);
+              data->supports_cu_mem_host_register = value;
               if (CUDA_CHECK_ERROR (result, "cuDeviceGetAttribute"))
                 ret = CL_INVALID_DEVICE;
             } else {
@@ -429,7 +432,7 @@ pocl_cuda_init (unsigned j, cl_device_id dev, const char *parameters)
               data->supports_cu_mem_host_register = pocl_get_bool_option ("POCL_CUDA_SUPPORTS_CU_MEM_HOST_REGISTER", 1);
 #endif
             }
-	}
+        }
     }
 
   dev->preferred_wg_size_multiple = 32;
